version: '3.8'

services:
  oss-knowledge-search:
    build: .
    container_name: oss-knowledge-search
    ports:
      - "8002:8002"
    environment:
      - APP_NAME=OSS Knowledge Search Server
      - HOST=0.0.0.0
      - PORT=8002
      - DEBUG=false
      - LOG_LEVEL=INFO
      
      # Vector Database
      - QDRANT_HOST=${QDRANT_HOST:-localhost}
      - QDRANT_PORT=${QDRANT_PORT:-6333}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-general}
      
      # Graph Database
      - NEO4J_URI=${NEO4J_URI:-neo4j://localhost:7687}
      - NEO4J_USERNAME=${NEO4J_USERNAME:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-password}
      
      # Azure OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION:-2024-12-01-preview}
      - AZURE_EMBEDDING_DEPLOYMENT=${AZURE_EMBEDDING_DEPLOYMENT:-oss-embedding}
      - AZURE_EMBEDDING_MODEL=${AZURE_EMBEDDING_MODEL:-text-embedding-3-large}
      
      # Search Configuration
      - VECTOR_SIZE=${VECTOR_SIZE:-3072}
      - DEFAULT_SEARCH_LIMIT=10
      - MAX_SEARCH_LIMIT=100
      - DEFAULT_SIMILARITY_THRESHOLD=0.7
      
    volumes:
      - ./logs:/app/logs
    networks:
      - oss-knowledge-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  oss-knowledge-net:
    driver: bridge
    external: true