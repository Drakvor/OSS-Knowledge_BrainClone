# GitLab CI/CD Pipeline for MEM0 Azure Deployment

stages:
  - validate
  - security
  - trigger-jenkins
  - notify

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# ì½”ë“œ ê²€ì¦ ë‹¨ê³„
validate:
  stage: validate
  image: python:3.11-slim
  before_script:
    - pip install -r requirements.txt
    - pip install flake8 black pytest
  script:
    - echo "ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì¤‘..."
    - flake8 src/ --max-line-length=88 --exclude=__pycache__ || true
    - black --check src/ || true
    - echo "âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ"
  only:
    - merge_requests
    - main
    - develop

# ë³´ì•ˆ ìŠ¤ìº”
security-scan:
  stage: security
  image: alpine:latest
  before_script:
    - apk add --no-cache grep
  script:
    - echo "ğŸ”’ ë³´ì•ˆ ìŠ¤ìº” ì¤‘..."
    - |
      if grep -r "password\|secret\|key\|token" --include="*.py" --include="*.yaml" --exclude-dir=".git" . | grep -v "template\|example\|TODO"; then
        echo "âš ï¸ WARNING: ì ì¬ì  ì‹œí¬ë¦¿ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤"
        echo "ë‹¤ìŒ íŒ¨í„´ë“¤ì„ í™•ì¸í•´ì£¼ì„¸ìš”:"
        grep -r "password\|secret\|key\|token" --include="*.py" --include="*.yaml" --exclude-dir=".git" . | grep -v "template\|example\|TODO" || true
      fi
    - echo "âœ… ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ"
  only:
    - merge_requests
    - main
    - develop

# Jenkins ë¹Œë“œ íŠ¸ë¦¬ê±°
trigger-jenkins:
  stage: trigger-jenkins
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "ğŸš€ Jenkins íŒŒì´í”„ë¼ì¸ íŠ¸ë¦¬ê±° ì¤‘..."
    - |
      RESPONSE=$(curl -w "%{http_code}" -s -X POST \
        -H "Authorization: Bearer ${JENKINS_API_TOKEN}" \
        "${JENKINS_URL}/job/mem0-build-pipeline/buildWithParameters" \
        --data-urlencode "GIT_COMMIT=${CI_COMMIT_SHA}" \
        --data-urlencode "GIT_BRANCH=${CI_COMMIT_REF_NAME}" \
        --data-urlencode "GITLAB_PROJECT_ID=${CI_PROJECT_ID}" \
        --data-urlencode "GITLAB_PIPELINE_ID=${CI_PIPELINE_ID}")
      
      HTTP_CODE="${RESPONSE: -3}"
      if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
        echo "âœ… Jenkins ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë˜ì—ˆìŠµë‹ˆë‹¤"
        echo "Jenkins URL: ${JENKINS_URL}/job/mem0-build-pipeline/"
      else
        echo "âŒ Jenkins ë¹Œë“œ íŠ¸ë¦¬ê±° ì‹¤íŒ¨: HTTP $HTTP_CODE"
        exit 1
      fi
  only:
    - main
    - develop
  when: manual

# ì•Œë¦¼ ì „ì†¡
notify-success:
  stage: notify
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "ğŸ“¢ ì„±ê³µ ì•Œë¦¼ ì „ì†¡ ì¤‘..."
    - |
      curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"âœ… MEM0 GitLab Pipeline ì„±ê³µ!\në¸Œëœì¹˜: ${CI_COMMIT_REF_NAME}\nì»¤ë°‹: ${CI_COMMIT_SHORT_SHA}\níŒŒì´í”„ë¼ì¸: ${CI_PIPELINE_URL}\"}" \
        "${SLACK_WEBHOOK_URL}" || echo "Slack ì•Œë¦¼ ì‹¤íŒ¨ (ì„ íƒì‚¬í•­)"
  only:
    - main
    - develop
  when: on_success

notify-failure:
  stage: notify
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "ğŸ“¢ ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡ ì¤‘..."
    - |
      curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"âŒ MEM0 GitLab Pipeline ì‹¤íŒ¨!\në¸Œëœì¹˜: ${CI_COMMIT_REF_NAME}\nì»¤ë°‹: ${CI_COMMIT_SHORT_SHA}\níŒŒì´í”„ë¼ì¸: ${CI_PIPELINE_URL}\"}" \
        "${SLACK_WEBHOOK_URL}" || echo "Slack ì•Œë¦¼ ì‹¤íŒ¨ (ì„ íƒì‚¬í•­)"
  only:
    - main
    - develop
  when: on_failure
